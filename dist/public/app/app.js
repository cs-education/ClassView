"use strict";angular.module("classViewApp.resources",["ngResource"]).constant("API_BASE_URL","/api/"),angular.module("classViewApp",["ngCookies","ngResource","ngSanitize","ui.router","ui.bootstrap","com.2fdevs.videogular","com.2fdevs.videogular.plugins.controls","classViewApp.resources"]).config(["$stateProvider","$urlRouterProvider","$httpProvider","$locationProvider",function(a,b,c,d){d.html5Mode(!0),c.interceptors.push("interceptor")}]),angular.module("classViewApp").controller("ClassViewCtrl",["$scope","$q","Course","Section","Recording","buildIntervalQuery","getUrlForVideo","formatRecording","_",function(a,b,c,d,e,f,g,h,i){function j(a){var c=b.defer();return c.resolve(a),c.promise}function k(a){return i.merge(a,{videoSources:[{src:g(a.filename),type:"video/mp4"}]})}function l(c){var d=c.startTime,g=c.endTime;return s.then(function(a){var c=a.map(function(a){var b=f({startTime:d,endTime:g},a);return e.query(b).$promise});return b.all(c)}).then(function(a){return i.flatten(a)}).then(function(b){return b.forEach(h),a.searchResults=b.map(k),a.searchResults=i.sortByAll(a.searchResults,["section.id","startTime","endTime"]),a.mainVideo=a.searchResults.shift(),b})}function m(a,b,c){return a>c?a:c>b?b:c}function n(b,c){return c=c||a.currentTime,b.startTime<=c&&b.endTime>=c}function o(b,c){c=c||a.currentTime;var d=c.getTime()-b.startTime.getTime(),e=d/1e3;e=m(0,b.API.totalTime,e),b==a.mainVideo&&(console.log("videoSeekTimeSecs="+e),console.log("$scope.mainVideo.API.seekTime=\n"+a.mainVideo.API.seekTime.toString())),b.API.seekTime(e)}function p(b){if(!(b.getTime()-t.getTime()<r)){var c=function(a){return n(a,b)},d=a.searchResults.filter(c),e=a.searchResults.filter(i.negate(c));d=d.filter(function(a){return a.API}),d.forEach(function(a){o(a,b)});var f=d.concat(e);i.isEqual(a.searchResults,f)||(a.searchResults=f),t=b}}function q(b){return b=b||a.course,c.get({id:b}).$promise.then(function(a){return a.sections})}var r=500;a.searchResults=[],a.mainVideo=null,a.isPlaying=!1,a.autoPlay=!1,a.currentTime=new Date(0);var s=j([]),t=new Date(0);a.mediaPlayer.onSetInterval(function(a){var b=a.startTime,c=a.endTime;return l({startTime:b,endTime:c})}),a.getUrlForVideo=g;var u=b.defer();a.attatchMainVideoAPI=function(b){console.log("attatchMainVideoAPI()"),a.mainVideo.API=b,u.resolve(b)},a.makeMainVideo=function(c){var d=a.currentTime;u=b.defer();var e=i.findWhere(a.searchResults,{id:c});a.searchResults.push(a.mainVideo),a.mainVideo=e,i.remove(a.searchResults,{id:c}),n(a.mainVideo,d)?(console.log("isLive"),console.log("$scope.mainVideo.API exists="+!i.isUndefined(a.mainVideo.API)),a.mainVideo.API&&u.resolve(a.mainVideo.API),u.promise.then(function(b){console.log("received mainVideo API"),a.currentTime=d,b.pause(),o(a.mainVideo),a.autoPlay=a.isPlaying})):a.autoPlay=!1,t=new Date(0)},a.onUpdateTime=function(b){var c=1e3*b,d=a.mainVideo.startTime.getTime();a.currentTime=new Date(d+c)},a.onStateChange=function(b){console.log("state: "+b),a.isPlaying="play"===b,console.log("mainVideo.currentTime="+a.mainVideo.API.currentTime)},a.$watch("currentTime",function(a,b){p(a)}),a.$watch("course",function(b,c){b!==c&&(s=q(b),l({startTime:a.startTime,endTime:a.endTime}))})}]),angular.module("classViewApp").directive("classView",function(){return{templateUrl:"app/classView/classView.html",restrict:"EA",scope:{mediaPlayer:"=",course:"=?",apiHost:"=?"}}}),angular.module("classViewApp").factory("interceptor",function(){return{request:function(a){return a.headers["consumer-device-id"]=String(Date.now()*Math.random()*100),a}}}),angular.module("classViewApp").factory("_",function(){return window._}),angular.module("classViewApp").factory("MediaPlayer",["$q","_",function(a,b){var c=function d(){var c=this;this.setIntervalCbDeferred=a.defer(),this.onSetIntervalCallback=b.noop,this.onSeekCallback=b.noop,this.onPauseCallback=b.noop,this.onPlayCallback=b.noop,d.prototype.onSetInterval=function(a){return c.onSetIntervalCallback=a,c.setIntervalCbDeferred.resolve(c),c},d.prototype.setInterval=function(a){var b=a.startTime,d=a.endTime;return c.setIntervalCbDeferred.promise.then(function(a){return a.onSetIntervalCallback({startTime:b,endTime:d})})},d.prototype.onSeek=function(a){return c.onSeekCallback=a,c},d.prototype.onPause=function(a){return c.onPauseCallback=a,c},d.prototype.onPlay=function(a){return c.onPlayCallback=a,c}};return c}]),angular.module("classViewApp").factory("Course",["$resource","API_BASE_URL",function(a,b){return a(b+"/course/:id",{id:"@id"})}]),angular.module("classViewApp.resources").factory("Recording",["$resource","API_BASE_URL",function(a,b){return a(b+"/recording/:id",{id:"@id"})}]).factory("formatRecording",function(){return function(a){return a.startTime=new Date(a.startTime),a.endTime=new Date(a.endTime),a.createdAt=new Date(a.createdAt),a.updatedAt=new Date(a.updatedAt),a}}).factory("buildIntervalQuery",function(){return function(a,b){var c=a.startTime,d=a.endTime,e={where:JSON.stringify({startTime:{">=":c},endTime:{"<=":d}})};return section&&(e.section=b),e}}).factory("getUrlForVideo",["API_BASE_URL",function(a){return function(b){return[a,"getVideo",b].join("/")}}]),angular.module("classViewApp").factory("Section",["$resource","API_BASE_URL",function(a,b){return a(b+"/section/:id",{id:"@id"})}]),angular.module("classViewApp").factory("Modal",["$rootScope","$modal",function(a,b){function c(c,d){var e=a.$new();return c=c||{},d=d||"modal-default",angular.extend(e,c),b.open({templateUrl:"components/modal/modal.html",windowClass:d,scope:e})}return{confirm:{"delete":function(a){return a=a||angular.noop,function(){var b,d=Array.prototype.slice.call(arguments),e=d.shift();b=c({modal:{dismissable:!0,title:"Confirm Delete",html:"<p>Are you sure you want to delete <strong>"+e+"</strong> ?</p>",buttons:[{classes:"btn-danger",text:"Delete",click:function(a){b.close(a)}},{classes:"btn-default",text:"Cancel",click:function(a){b.dismiss(a)}}]}},"modal-danger"),b.result.then(function(b){a.apply(b,d)})}}}}}]),angular.module("classViewApp").run(["$templateCache",function(a){a.put("app/classView/classView.html",'<div ng-controller=ClassViewCtrl><videogular ng-if=mainVideo class=videogular-container vg-player-ready=attatchMainVideoAPI($API) vg-update-time=onUpdateTime($currentTime) vg-update-state=onStateChange($state) vg-auto-play=autoPlay><vg-media vg-src=mainVideo.videoSources vg-chromecast title="Course Video Content" description="{{mainVideo.startTime}} to {{mainVideo.endTime}}"></vg-media><vg-controls><vg-play-pause-button></vg-play-pause-button><vg-time-display>{{ currentTime | date:\'mm:ss\' }}</vg-time-display><vg-scrub-bar><vg-scrub-bar-current-time></vg-scrub-bar-current-time></vg-scrub-bar><vg-time-display>{{ timeLeft | date:\'mm:ss\' }}</vg-time-display><vg-volume><vg-mute-button></vg-mute-button><vg-volume-bar></vg-volume-bar></vg-volume><vg-chromecast-button></vg-chromecast-button><vg-fullscreen-button></vg-fullscreen-button></vg-controls><vg-overlay-play></vg-overlay-play></videogular><div class="row row-horizon well" ng-if=searchResults.length><div class=col-md-6 ng-repeat="videoObject in searchResults"><videogular class=videogular-container ng-click=makeMainVideo(videoObject.id) vg-player-ready="videoObject.API = $API"><vg-media vg-src=videoObject.videoSources></vg-media><vg-overlay-play></vg-overlay-play></videogular></div></div></div>'),a.put("components/modal/modal.html",'<div class=modal-header><button ng-if=modal.dismissable type=button ng-click=$dismiss() class=close>&times;</button><h4 ng-if=modal.title ng-bind=modal.title class=modal-title></h4></div><div class=modal-body><p ng-if=modal.text ng-bind=modal.text></p><div ng-if=modal.html ng-bind-html=modal.html></div></div><div class=modal-footer><button ng-repeat="button in modal.buttons" ng-class=button.classes ng-click=button.click($event) ng-bind=button.text class=btn></button></div>')}]);